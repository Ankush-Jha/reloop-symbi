<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Test Data - ReLoop</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h1 {
            color: #22c358;
        }

        h2 {
            color: #22c358;
            margin-top: 0;
        }

        button {
            background: #22c358;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .success {
            color: #22c358;
        }

        .error {
            color: #ff6b6b;
        }

        .info {
            color: #74b9ff;
        }

        .status {
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .status.ready {
            background: #22c358;
            color: #000;
        }

        .status.not-ready {
            background: #ff6b6b;
            color: #fff;
        }
    </style>
</head>

<body>
    <h1>üîß ReLoop Test Data Setup</h1>

    <div class="card">
        <h2>Current Status</h2>
        <p>User: <span id="user-status" class="status not-ready">Checking...</span></p>
        <p>User ID: <code id="user-id">-</code></p>
    </div>

    <div class="card">
        <h2>Step 1: Create Test Seller</h2>
        <p>Creates a test user profile in Firestore that you can use as a seller.</p>
        <button id="create-seller-btn" onclick="createTestSeller()">Create Test Seller</button>
    </div>

    <div class="card">
        <h2>Step 2: Create Test Listing</h2>
        <p>Creates a listing owned by the test seller that you can trade for.</p>
        <button id="create-listing-btn" onclick="createTestListing()">Create Test Listing</button>
    </div>

    <div class="card">
        <h2>Step 3: Test the Flow</h2>
        <p>After creating the test listing, go to marketplace and click on "Test Seller's Vintage Lamp" and request a
            trade.</p>
        <button onclick="window.location.href='marketplace.html'">Go to Marketplace ‚Üí</button>
    </div>

    <div class="card">
        <h2>Global Mock Data</h2>
        <p>Populate ALL users with mock stats and create fake leaderboard entries.</p>
        <button onclick="seedAllUsers()" style="background: #9C27B0; color: white;">Seed Everyone</button>
        <button onclick="seedSpecificSquad()"
            style="background: #2196F3; color: white; margin-top: 10px; display: block; width: 100%;">Seed Squad
            Only</button>
    </div>

    <div class="card">
        <h2>Debug Actions</h2>
        <button onclick="checkConversations()">Check My Conversations</button>
        <button onclick="checkListings()">Check All Listings</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="card">
        <h2>Log Output</h2>
        <div id="log" class="log">Waiting for actions...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/services/database.js"></script>
    <script src="../../js/app.js"></script>

    <script>
        const TEST_SELLER_ID = 'test-seller-001';
        let currentUserId = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type;
            logEl.innerHTML += `<span class="${className}">[${time}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function createTestSeller() {
            log('Creating test seller...', 'info');

            try {
                const testSeller = {
                    name: 'TestSeller',
                    email: 'testseller@example.com',
                    campus: 'North Campus',
                    coins: 500,
                    xp: 1000,
                    itemsTraded: 25,
                    co2Saved: 45.5,
                    avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=testseller',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(TEST_SELLER_ID).set(testSeller);
                log('‚úÖ Test seller created successfully!', 'success');
                log(`   ID: ${TEST_SELLER_ID}`, 'success');
                log(`   Name: ${testSeller.name}`, 'success');
            } catch (error) {
                log(`‚ùå Error creating test seller: ${error.message}`, 'error');
            }
        }

        async function createTestListing() {
            log('Creating test listing...', 'info');

            try {
                const testListing = {
                    sellerId: TEST_SELLER_ID,
                    title: "Test Seller's Vintage Lamp",
                    description: "A beautiful vintage lamp perfect for your dorm room. In great condition!",
                    category: "Electronics",
                    condition: "Excellent",
                    price: 30,
                    images: [
                        "https://images.unsplash.com/photo-1507473885765-e6ed057f782c?w=400"
                    ],
                    status: 'available',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                };

                const docRef = await db.collection('listings').add(testListing);
                log('‚úÖ Test listing created successfully!', 'success');
                log(`   ID: ${docRef.id}`, 'success');
                log(`   Title: ${testListing.title}`, 'success');
                log(`   Price: ${testListing.price} coins`, 'success');
                log('', 'info');
                log('Now go to the marketplace to see the listing!', 'info');
            } catch (error) {
                log(`‚ùå Error creating test listing: ${error.message}`, 'error');
            }
        }

        async function checkConversations() {
            log('Checking conversations...', 'info');

            try {
                if (!currentUserId) {
                    log('‚ùå Not logged in', 'error');
                    return;
                }

                const conversations = await DatabaseService.getConversations('all');
                log(`Found ${conversations.length} conversation(s):`, 'info');

                conversations.forEach((conv, i) => {
                    log(`  ${i + 1}. ID: ${conv.id}`, 'info');
                    log(`     With: ${conv.otherUser?.name || 'Unknown'}`, 'info');
                    log(`     Listing: ${conv.listing?.title || 'N/A'}`, 'info');
                    log(`     Last message: ${conv.lastMessage}`, 'info');
                });

                if (conversations.length === 0) {
                    log('No conversations found. Try requesting a trade on a test listing.', 'info');
                }
            } catch (error) {
                log(`‚ùå Error checking conversations: ${error.message}`, 'error');
            }
        }

        async function checkListings() {
            log('Checking listings...', 'info');

            try {
                const listings = await DatabaseService.getListings();
                log(`Found ${listings.length} available listing(s):`, 'info');

                listings.forEach((listing, i) => {
                    const isOwn = listing.sellerId === currentUserId ? ' (YOUR ITEM)' : '';
                    log(`  ${i + 1}. ${listing.title}${isOwn}`, 'info');
                    log(`     ID: ${listing.id}`, 'info');
                    log(`     Seller: ${listing.seller?.name || listing.sellerId}`, 'info');
                    log(`     Price: ${listing.price} coins`, 'info');
                });
            } catch (error) {
                log(`‚ùå Error checking listings: ${error.message}`, 'error');
            }
        }

        // Seed ALL Users with Mock Data (for demo "rich" look)
        async function seedAllUsers() {
            try {
                const logs = document.getElementById('log');
                log('Starting global seeding...', 'info');

                // 1. Update Existing Users
                const usersSnapshot = await db.collection('users').get();
                const totalUsers = usersSnapshot.size;
                log(`Found ${totalUsers} existing users. Updating...`, 'info');

                const updates = usersSnapshot.docs.map(doc => {
                    return doc.ref.update({
                        itemsTraded: 12,
                        co2Saved: 24.5,
                        coins: 850,
                        xp: 2450, // Enough for Level 8
                        messagesSent: 5,
                        itemsScanned: 8,
                        level: 8
                    });
                });

                await Promise.all(updates);
                log('All existing users updated with mock stats.', 'success');

                // 2. Create Fake Leaderboard Users
                const fakeUsers = [
                    { id: 'fake_user_1', name: 'GreenQueen', xp: 12500, coins: 5000, itemsTraded: 45, co2Saved: 120, level: 16 },
                    { id: 'fake_user_2', name: 'EcoMaster', xp: 9800, coins: 3200, itemsTraded: 30, co2Saved: 85, level: 14 },
                    { id: 'fake_user_3', name: 'RecycleRocky', xp: 7500, coins: 2100, itemsTraded: 25, co2Saved: 60, level: 12 },
                    { id: 'fake_user_4', name: 'PlanetPat', xp: 5200, coins: 1500, itemsTraded: 18, co2Saved: 40, level: 11 },
                    { id: 'fake_user_5', name: 'SustainableSam', xp: 3300, coins: 900, itemsTraded: 15, co2Saved: 30, level: 9 }
                ];

                const fakeUpdates = fakeUsers.map(user => {
                    return db.collection('users').doc(user.id).set({
                        name: user.name,
                        xp: user.xp,
                        coins: user.coins,
                        itemsTraded: user.itemsTraded,
                        co2Saved: user.co2Saved,
                        level: user.level,
                        photoURL: `https://ui-avatars.com/api/?name=${user.name}&background=random`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await Promise.all(fakeUpdates);
                log('Created 5 fake leaderboard users.', 'success');
                log('GLOBAL SEEDING COMPLETE!', 'success');

            } catch (error) {
                console.error("Seeding Error:", error);
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Seed Specific Squad (Ankush, Unnati, Uransh, Rudrakh)
        async function seedSpecificSquad() {
            try {
                const logs = document.getElementById('log');
                log('Starting squad seeding...', 'info');

                const squad = [
                    { id: 'user_ankush', name: 'Ankush Jha', xp: 15000, coins: 5000, itemsTraded: 55, co2Saved: 150.5, level: 18, badges: ['sustainability-pioneer', 'early-adopter'] },
                    { id: 'user_unnati', name: 'Unnati Asthana', xp: 13500, coins: 4200, itemsTraded: 48, co2Saved: 130.0, level: 16, badges: ['early-adopter'] },
                    { id: 'user_uransh', name: 'Uransh', xp: 11000, coins: 3500, itemsTraded: 35, co2Saved: 95.5, level: 14, badges: ['newcomer'] },
                    { id: 'user_rudrakh', name: 'Rudrakh Bairagi', xp: 9500, coins: 2800, itemsTraded: 28, co2Saved: 75.0, level: 12, badges: ['newcomer'] }
                ];

                // 1. Delete old fake users if they exist (to clean up)
                const oldFakes = ['fake_user_1', 'fake_user_2', 'fake_user_3', 'fake_user_4', 'fake_user_5'];
                const deletePromises = oldFakes.map(id => db.collection('users').doc(id).delete());
                await Promise.all(deletePromises);
                log('Cleaned up old fake users.', 'info');

                // 2. Create/Update Squad
                const squadUpdates = squad.map((user, index) => {
                    return db.collection('users').doc(user.id).set({
                        name: user.name,
                        xp: user.xp,
                        coins: user.coins,
                        itemsTraded: user.itemsTraded,
                        co2Saved: user.co2Saved,
                        level: user.level,
                        badges: user.badges,
                        photoURL: `https://ui-avatars.com/api/?name=${user.name}&background=random&color=fff`,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rank: index + 1 // Ideally rank is dynamic, but this sets order
                    });
                });

                await Promise.all(squadUpdates);
                log('Created SQUAD profiles: Ankush, Unnati, Uransh, Rudrakh.', 'success');
                log('SQUAD SEEDING COMPLETE!', 'success');

            } catch (error) {
                console.error("Seeding Error:", error);
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Initialize
        firebase.auth().onAuthStateChanged(user => {
            const statusEl = document.getElementById('user-status');
            const userIdEl = document.getElementById('user-id');

            if (user) {
                currentUserId = user.uid;
                statusEl.textContent = 'Logged In';
                statusEl.className = 'status ready';
                userIdEl.textContent = user.uid;
                log(`‚úÖ User authenticated: ${user.uid}`, 'success');
            } else {
                statusEl.textContent = 'Not Logged In';
                statusEl.className = 'status not-ready';
                userIdEl.textContent = 'N/A';
                log('‚ö†Ô∏è Not logged in. Please log in first.', 'error');
            }
        });
    </script>
</body>

</html>
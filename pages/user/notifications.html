<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - ReLoop</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../../css/styles.css">

    <style>
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .page-title {
            font-size: var(--text-xl);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .main-content {
            padding-bottom: 100px;
        }

        /* Section Headers */
        .section-header {
            padding: var(--space-4);
            font-size: var(--text-sm);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            background: var(--color-surface-dark);
        }

        /* Notification Item */
        .notification-item {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background var(--transition-base);
        }

        .notification-item:hover {
            background: var(--color-surface-dark);
        }

        .notification-item.unread {
            background: rgba(34, 195, 88, 0.05);
        }

        .notification-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.trade {
            background: rgba(34, 195, 88, 0.2);
        }

        .notification-icon.trade .icon {
            color: var(--color-primary);
        }

        .notification-icon.recycle {
            background: rgba(59, 130, 246, 0.2);
        }

        .notification-icon.recycle .icon {
            color: var(--color-info);
        }

        .notification-icon.alert {
            background: rgba(245, 158, 11, 0.2);
        }

        .notification-icon.alert .icon {
            color: var(--color-warning);
        }

        .notification-icon.coins {
            background: rgba(251, 191, 36, 0.2);
        }

        .notification-icon.coins .icon {
            color: var(--color-coin);
        }

        .notification-icon .icon {
            font-size: 24px;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: var(--text-base);
            font-weight: 600;
            margin-bottom: var(--space-1);
            line-height: 1.4;
        }

        .notification-item.unread .notification-title {
            font-weight: 700;
        }

        .notification-time {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        .notification-product {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid var(--color-border);
        }

        .notification-product img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-16) var(--space-8);
            text-align: center;
        }

        .empty-state .icon {
            font-size: 64px;
            color: var(--color-text-muted);
            margin-bottom: var(--space-4);
        }

        .empty-state .title {
            font-size: var(--text-lg);
            font-weight: 700;
            margin-bottom: var(--space-2);
        }

        .empty-state .description {
            font-size: var(--text-base);
            color: var(--color-text-muted);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="page-header">
            <a href="../core/home.html" class="icon-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1 class="page-title">Notifications</h1>
            <button class="icon-btn">
                <span class="material-symbols-outlined">done_all</span>
            </button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Today -->
            <div id="notifications-list">
                <div class="loading-state" style="text-align: center; padding: 40px; color: var(--color-text-muted);">
                    Loading notifications...
                </div>
            </div>
        </main>
    </div>

    <!-- Noise Overlay -->
    <div class="noise-overlay"></div>

    <script src="../../js/app.js"></script>
    <script src="../../js/services/database.js"></script>

    <script>
        async function loadNotifications() {
            const userId = getCurrentUserId();
            if (!userId) return;

            const list = document.getElementById('notifications-list');

            try {
                const notifications = await DatabaseService.getNotifications(userId);

                if (notifications.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <span class="material-symbols-outlined icon">notifications_off</span>
                            <div class="title">No new notifications</div>
                            <div class="description">We'll notify you when something happens!</div>
                        </div>
                    `;
                    return;
                }

                // Group by date (Today, Yesterday, Earlier)
                const groups = {
                    today: [],
                    yesterday: [],
                    earlier: []
                };

                const today = new Date().toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toDateString();

                notifications.forEach(n => {
                    const date = n.createdAt ? n.createdAt.toDate().toDateString() : today;
                    if (date === today) groups.today.push(n);
                    else if (date === yesterdayString) groups.yesterday.push(n);
                    else groups.earlier.push(n);
                });

                let html = '';

                // Helper to render section
                const renderSection = (title, items) => {
                    if (items.length === 0) return '';
                    return `
                        <div class="section-header">${title}</div>
                        ${items.map(n => {
                        const iconMap = {
                            trade: { icon: 'swap_horiz', class: 'trade' },
                            recycle: { icon: 'recycling', class: 'recycle' },
                            coins: { icon: 'eco', class: 'coins' },
                            alert: { icon: 'notifications', class: 'alert' }
                        };
                        const type = iconMap[n.type] || iconMap.alert;
                        const time = n.createdAt ? formatTimeAgo(n.createdAt.toDate()) : 'Just now';

                        return `
                                <div class="notification-item stagger-item ${!n.read ? 'unread' : ''}" onclick="markRead('${n.id}')">
                                    <div class="notification-icon ${type.class}">
                                        <span class="material-symbols-outlined icon">${type.icon}</span>
                                    </div>
                                    <div class="notification-content">
                                        <div class="notification-title">${n.title || n.message}</div>
                                        <div class="notification-time">${time}</div>
                                    </div>
                                    ${n.image ? `
                                        <div class="notification-product">
                                            <img src="${n.image}" alt="Item">
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                    }).join('')}
                    `;
                };

                html += renderSection('Today', groups.today);
                html += renderSection('Yesterday', groups.yesterday);
                html += renderSection('Earlier', groups.earlier);

                list.innerHTML = html;

            } catch (error) {
                console.error('Error loading notifications:', error);
                list.innerHTML = '<div class="error-msg" style="text-align:center; padding: 20px;">Failed to load notifications</div>';
            }
        }

        async function markRead(id) {
            const userId = getCurrentUserId();
            if (userId && id) {
                await DatabaseService.markNotificationRead(userId, id);
                // remove unread class visually
                event.currentTarget.classList.remove('unread');
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        firebase.auth().onAuthStateChanged(user => {
            if (user) loadNotifications();
        });
    </script>
</body>

</html>
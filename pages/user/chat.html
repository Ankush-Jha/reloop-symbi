<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ReLoop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../css/styles.css">
    <style>
        .chat-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
            background: var(--color-surface-dark);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-size: var(--text-base);
            font-weight: 700;
        }

        .chat-header-status {
            font-size: var(--text-xs);
            color: var(--color-primary);
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            overflow: hidden;
            border: 2px solid var(--color-primary);
        }

        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-messages {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            padding-bottom: 180px;
        }

        .message {
            max-width: 80%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-xl);
            font-size: var(--text-sm);
            line-height: 1.5;
        }

        .message.received {
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            align-self: flex-start;
            border-bottom-left-radius: var(--radius-sm);
        }

        .message.sent {
            background: var(--color-primary);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message-time {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .message.sent .message-time {
            color: rgba(0, 0, 0, 0.5);
            text-align: right;
        }

        .product-preview {
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-3);
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .product-preview-image {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .product-preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-preview-info {
            flex: 1;
        }

        .product-preview-title {
            font-size: var(--text-sm);
            font-weight: 700;
            margin-bottom: 2px;
        }

        .product-preview-price {
            font-size: var(--text-sm);
            color: var(--color-primary);
            font-weight: 700;
        }

        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--color-surface-dark);
            border-top: 1px solid var(--color-border);
            padding: var(--space-4);
        }

        .chat-input-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chat-input {
            flex: 1;
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            padding: var(--space-3) var(--space-4);
            color: var(--color-text-primary);
            font-family: var(--font-display);
            font-size: var(--text-sm);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .chat-input::placeholder {
            color: var(--color-text-muted);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn .icon {
            font-size: 20px;
            color: #000;
        }

        .quick-actions {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .quick-action-btn {
            background: var(--color-surface-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .quick-action-btn:hover {
            background: var(--color-primary);
            color: #000;
            border-color: var(--color-primary);
        }

        .date-divider {
            text-align: center;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin: var(--space-4) 0;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Chat Header -->
        <header class="chat-header">
            <a href="messages.html" class="icon-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div class="chat-header-avatar">
                <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuCO5YCi5O8FCLfzUebEZGo06paGggAst7_OzvlELDu9jWEIQ4xRNKiu0nq2MbFhXCq0L7iCNg8iVmouKSptH3pdPELpp2ZmWltKoYBcpVPJ3iXnwH1iSv3_HUvnX-dfxhlu6mQu-hQ9-S9UbDOQKNj1BZTtRoVzHqZtlSk4vFQtFB2LwkyofmzIRoinY4RPXfh8WsYp8p0oXRpyHTQxjgkWdfVoQ15iV0ttkJ50gkYa8pj511ITFvI-V7vLnV7ZMHEwVUtiG1MxyRk"
                    alt="StudentJane">
            </div>
            <div class="chat-header-info">
                <div class="chat-header-name">@StudentJane</div>
                <div class="chat-header-status">Online now</div>
            </div>
            <button class="icon-btn">
                <span class="material-symbols-outlined">more_vert</span>
            </button>
        </header>

        <!-- Product Preview -->
        <div style="padding: var(--space-4);">
            <div class="product-preview">
                <div class="product-preview-image">
                    <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuCOZLbQifWnnYreCLEPRRXYOgzNYuIJC4xQEp-JQfLaHVnfmh7ZAdk15-aNDuU0RPAemdPt7nAAjh3llfm0LG2xKLXs49cIEsbH2e8PqV3IK15t3n9H7GwTmtcsexm9BYgnT-tRBXW6WMPkE9gPXhVMTkBr3qTmEeFDgb5IYE_bPeeVLgQTcdoNR3tRR8LNBihFnfE73hPE7LdYWDSS5LfHzCUPaMF405A4BjVyBH8x2eUZK1NBupbH02J9j1WolQ0l52EeOiQy2dw"
                        alt="Jacket">
                </div>
                <div class="product-preview-info">
                    <div class="product-preview-title">Vintage Denim Jacket</div>
                    <div class="product-preview-price">25 Coins</div>
                </div>
                <a href="../marketplace/item.html" class="icon-btn" style="align-self: center;">
                    <span class="material-symbols-outlined">open_in_new</span>
                </a>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages">
            <div class="date-divider">Today</div>

            <div class="message received">
                <p>Hey! I saw you're interested in my jacket üëã</p>
                <div class="message-time">2:30 PM</div>
            </div>

            <div class="message sent">
                <p>Yes! It looks great. Is it still available?</p>
                <div class="message-time">2:31 PM</div>
            </div>

            <div class="message received">
                <p>Absolutely! It's in excellent condition. Only worn a few times. Would you like to meet up to check it
                    out?</p>
                <div class="message-time">2:32 PM</div>
            </div>

            <div class="message sent">
                <p>That would be great! When and where works for you?</p>
                <div class="message-time">2:33 PM</div>
            </div>

            <div class="message received">
                <p>Awesome! I can meet you at North Campus tomorrow at 3pm üëç</p>
                <div class="message-time">2:35 PM</div>
            </div>
        </div>

        <!-- Chat Input Area -->
        <div class="chat-input-area">
            <div class="quick-actions" id="quick-actions">
                <button class="quick-action-btn" onclick="shareLocation()">üìç Share Location</button>
                <button id="qr-btn" class="quick-action-btn" style="display: none;" onclick="showTradeQR()">üîê Show
                    QR</button>
                <button id="scan-btn" class="quick-action-btn" style="display: none;" onclick="openScanPage()">üì∑ Scan
                    QR</button>
                <button id="confirm-btn" class="quick-action-btn" style="display: none;" onclick="confirmTrade()">‚úÖ
                    Confirm Trade</button>
            </div>
            <div class="chat-input-row">
                <input type="text" id="message-input" class="chat-input" placeholder="Type a message..."
                    onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <span class="material-symbols-outlined icon">send</span>
                </button>
            </div>
        </div>
    </div>
    <div class="noise-overlay"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script src="../../js/services/database.js"></script>
    <script src="../../js/app.js"></script>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="../../js/services/qrcode-service.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');
        let unsubscribe = null;
        let currentUserId = null;
        let currentTradeId = null;
        let userRole = null; // 'buyer' or 'seller'

        // Load conversation and messages
        async function loadChat() {
            if (!conversationId) {
                console.log('No conversation ID, showing demo');
                return;
            }

            currentUserId = getCurrentUserId();
            if (!currentUserId) {
                console.log('Not logged in');
                return;
            }

            try {
                // Get conversation details
                const convDoc = await db.collection('conversations').doc(conversationId).get();
                if (!convDoc.exists) {
                    showToast('Conversation not found');
                    return;
                }

                const conv = convDoc.data();
                const otherUserId = conv.participants.find(id => id !== currentUserId);

                // Get other user info
                const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                const otherUser = otherUserDoc.exists ? otherUserDoc.data() : { name: 'User' };

                // Update header
                document.querySelector('.chat-header-name').textContent = `@${otherUser.name || 'User'}`;
                if (otherUser.avatar) {
                    document.querySelector('.chat-header-avatar img').src = otherUser.avatar;
                }

                // Get listing info if available
                if (conv.listingId) {
                    const listingDoc = await db.collection('listings').doc(conv.listingId).get();
                    if (listingDoc.exists) {
                        const listing = listingDoc.data();
                        document.querySelector('.product-preview-title').textContent = listing.title;
                        document.querySelector('.product-preview-price').textContent = `${listing.price} Coins`;
                        if (listing.images && listing.images.length > 0) {
                            document.querySelector('.product-preview-image img').src = listing.images[0];
                        }
                    }
                }

                // Subscribe to messages
                subscribeToMessages();

            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Subscribe to real-time messages
        function subscribeToMessages() {
            const messagesContainer = document.querySelector('.chat-messages');

            unsubscribe = db.collection('conversations').doc(conversationId)
                .collection('messages')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    // Keep the date divider
                    messagesContainer.innerHTML = '<div class="date-divider">Today</div>';

                    snapshot.docs.forEach(doc => {
                        const msg = doc.data();
                        const isSent = msg.senderId === currentUserId;
                        const time = msg.createdAt?.toDate();
                        const timeStr = time ? time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'Now';

                        messagesContainer.innerHTML += `
                            <div class="message ${isSent ? 'sent' : 'received'}">
                                <p>${escapeHtml(msg.text)}</p>
                                <div class="message-time">${timeStr}</div>
                            </div>
                        `;
                    });

                    // Auto-scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text || !conversationId) return;

            input.value = '';

            try {
                await DatabaseService.sendMessage(conversationId, text);
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message');
            }
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Quick actions
        function shareLocation() {
            sendQuickMessage('üìç Let\'s meet at the campus center!');
        }

        async function confirmTrade() {
            if (!conversationId) return;

            try {
                // Get the trade associated with this conversation
                const convDoc = await db.collection('conversations').doc(conversationId).get();
                if (!convDoc.exists) return;

                const conv = convDoc.data();

                // Find the trade
                const trades = await db.collection('trades')
                    .where('listingId', '==', conv.listingId)
                    .get();

                if (trades.empty) {
                    showToast('No pending trade found');
                    return;
                }

                const trade = trades.docs[0];
                const tradeData = trade.data();

                // Only seller can confirm
                if (tradeData.sellerId !== currentUserId) {
                    showToast('Only the seller can confirm the trade');
                    return;
                }

                // Check if QR was verified (skip for now, can add verification check here)
                // For now, we'll proceed with the confirmation

                const result = await DatabaseService.acceptTrade(trade.id);
                if (result.success) {
                    sendQuickMessage('‚úÖ Trade confirmed! Thanks for trading on ReLoop! üéâ');
                    showToast('Trade completed successfully!');
                } else {
                    showToast(result.error || 'Failed to confirm trade');
                }
            } catch (error) {
                console.error('Error confirming trade:', error);
                showToast('Failed to confirm trade');
            }
        }

        // Show QR code for buyer
        async function showTradeQR() {
            if (!currentTradeId || userRole !== 'buyer') {
                showToast('Only the buyer can show the verification QR');
                return;
            }

            try {
                await QRCodeService.showQRModal(currentTradeId, currentUserId);
                sendQuickMessage('üîê I\'ve generated my verification QR code. Ready when you are!');
            } catch (error) {
                console.error('Error showing QR:', error);
                showToast('Failed to generate QR code');
            }
        }

        // Open QR scanner page for seller
        function openScanPage() {
            if (!currentTradeId || userRole !== 'seller') {
                showToast('Only the seller can scan the QR code');
                return;
            }
            window.location.href = `verify-trade.html?tradeId=${currentTradeId}`;
        }

        // Update quick action buttons based on role
        function updateQuickActions() {
            const qrBtn = document.getElementById('qr-btn');
            const scanBtn = document.getElementById('scan-btn');
            const confirmBtn = document.getElementById('confirm-btn');

            if (userRole === 'buyer') {
                qrBtn.style.display = 'inline-flex';
                scanBtn.style.display = 'none';
                confirmBtn.style.display = 'none';
            } else if (userRole === 'seller') {
                qrBtn.style.display = 'none';
                scanBtn.style.display = 'inline-flex';
                confirmBtn.style.display = 'inline-flex';
            }
        }

        // Get trade info when loading chat
        async function loadTradeInfo() {
            if (!conversationId) return;

            try {
                const convDoc = await db.collection('conversations').doc(conversationId).get();
                if (!convDoc.exists) return;

                const conv = convDoc.data();

                // Determine role
                userRole = conv.buyerId === currentUserId ? 'buyer' : 'seller';
                console.log('[Chat] User role:', userRole);

                // Find the trade
                const trades = await db.collection('trades')
                    .where('listingId', '==', conv.listingId)
                    .where('status', '==', 'pending')
                    .get();

                if (!trades.empty) {
                    currentTradeId = trades.docs[0].id;
                    console.log('[Chat] Trade ID:', currentTradeId);
                }

                updateQuickActions();
            } catch (error) {
                console.error('Error loading trade info:', error);
            }
        }

        async function sendQuickMessage(text) {
            if (!conversationId) return;
            try {
                await DatabaseService.sendMessage(conversationId, text);
            } catch (error) {
                console.error('Error sending quick message:', error);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });

        // Load on auth state change
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                console.log('User logged in:', user.uid);
                loadChat();
                // Load trade info after a small delay to ensure chat is loaded
                setTimeout(() => loadTradeInfo(), 500);
            }
        });
    </script>
</body>

</html>